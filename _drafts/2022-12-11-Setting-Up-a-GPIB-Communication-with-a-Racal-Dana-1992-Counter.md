---
layout: post
title: Setting Up GPIB Communication with a Racal-Dana 1992 Universal Counter
date:  2022-12-11 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Introduction

In the past year, I've bought a bunch of measurement devices from a retired hobbyist who has
been downscaling his (extensive!) RF lab. During my last visit, he offered to add some extras for free, including
a Racal-Dana 1992 Universal Counter.

![Racal-Dana 1992 Universal Counter](/assets/racal1992/racal1992.jpg)

A 1992 can be used as a frequency counter, to measure the delay between two signals, to calculate the
clock frequency ratio between 2 signals, and various other special functions, for frequencies all
the way up to 1.3GHz. When you start digging into the wonderful world of 
[Time Nuts](http://www.leapsecond.com/time-nuts.htm), the 1992 seems to be well respected. There's
a known issue with the front panel switches, and there are plenty of Youtube video describing
how to fix it.

It didn't know it at the time, but its Buy-It-Now price on eBay is often higher than $500! *Thanks, John!*

My device came with option 55, a GPIB interface, and option 04E, a high stability oven controlled crystal 
oscillator ([OCXO](https://en.wikipedia.org/wiki/Crystal_oven)). The instrument has been calibrated using a 
GPS disciplined oscillator (GPSDO) as reference.

I've been looking at making a GPSDO myself, and thought it'd be interesting to use the 1992 to record
the phase difference between the raw, high jittery, GPS pulse-per-second (pps) signal that comes out of
a cheap GPS receiver, and the equivalent signal that's generated by the GPSDO. The first step to make
that happen is establish communication between my PC and the 1992 using GPIB. It sounds like something
that's relatively easy to do, but a few well-placed booby-traps turned it into something that took
a whole day before everything was working as expected.

This short blog post describes the road blocks and how to get past them.

# GPIB: MATE/CIIL vs default protocol

The issue to took most of my time was getting the 1992 to talk the right protocol. Section
5 of the [User Manual](/assets/racal1992/RACAL-DANA-1991-1992-UserManual.pdf) is straightforward
enough: you send a string with one or more 2 or 3 letter characters with optional numerical
parameters, and the device will sometimes reply with a string that's always 21 long.

The problem is that this didnt' work *at all*. When I'd send the internal self-test `CK` command,
I could see some LEDs temporarily flickering on the front panel and see the REM (remote) LED switch
permanently on, but every further GPIB transaction resulted in an error, and the device didn't
actually switch to `CK` mode either...

I eventually stumbled into [this conversation](https://www.eevblog.com/forum/testgear/racal-dana-1992-gpib-not-connecting/)
on the EEVblog forum, which mentions the existence of an SK4 jumper on some GPIB board versions that
must be set in the right position. It also links to an 
[amended version of the manual](/assets/racal1992/racal1992_UserMan.pdf), with the following
diagram at page 200/7-22:

![SK4 diagram](/assets/racal1992/SK4_diagram.png)

Opening up the 1992 can be done by removing just 2 screws, after which yo can slide the bottom part 
first, followed by the top:

![SK4 jumper in the chassis](/assets/racal1992/SK4_jumper_in_chassis.jpg)

Here's a closer look:

![SK4 jumper zoomed in](/assets/racal1992/SK4_jumper_zoomed_in.jpg)

This is how the jumper should be positioned if you want the GPIB interface to work as described
in the manual. In my case, the jumper was placed over the 2 pins right above it.

In the other position, the GPIB interface will conform to MATE/CIIL specification. Check out my
[updated blog post about test and measurement protocols](/2020/06/07/Making-Sense-of-Test-and-Measurement-Protocols.html#the-forgotten-mate-ciil-command-language)
to learn more about it. 

There are multiple versions of the GPIB interface board. From what I've been able to figure out, only version 
401820 has the SK4 jumper. It's part of option 02M which adds support for MATE/CIIL.

# Missing GPIB EOI at End of Message

With jumper SK4 in the right positions, the 1992 immediately behaved as expected when sending configuration
commands: `CK` puts it into self-check mode, `PA` switches to period measurement on channel A, and
so forth.

Reading back data was still an issue.

I'm using [`pyvisa`](https://pyvisa.readthedocs.io/en/latest/) for my GPIB adventures.

Here's the code that you'd expect to work:

```python
import pyvisa

rm=pyvisa.ResourceManager()
inst = rm.open_resource("GPIB::14")
inst.write("RGS")
inst.read()
```

The `RGS` command is supposed to return the firmware version of the device, but the code
times out:

```
```

The solution came, once again, after finding 
[this EEVblog forum post](https://www.eevblog.com/forum/testgear/racal-dana-1992-gpib-not-connecting/msg821521/#msg821521):

> I remember back when I was trying to get my 1992 working on GPIB, there was an 
> issue with the EOI line.  Apparently, the 1992 doesn't use it.  Make sure that your program isn't expecting it.

[This comment on a National Instruments forum](https://forums.ni.com/t5/Instrument-Control-GPIB-Serial/Default-GPIB-termination-character/m-p/242651#M12923)
gives more detail:

> The best default termination character is none. GPIB (IEEE 488.1) defines a 
> special hardware line, EOI, which is asserted with the last byte to signify 
> the end of a transfer. You should rely on this method to terminate a GPIB transfer, 
> as opposed to a termination byte that is stuffed into the bytestream. Some older 
> devices (primarily those that were initially RS-232) use only a EOS character, and 
> that can be CR, LF, or CR-LF, which is why the option exists to terminate a read 
> transfer on EOS with NI-488.2. 

> Most devices (such as those following the IEEE 488.2 protocol) use both (they send 
> a LF at the end with EOI asserted). Even in that case, however, you should only really 
> be concerned with the EOI since that is the native termination of the GPIB. 

So here's what's happening:

* All messages from the Racal 1992 to the controller (your PC) are exactly 21 bytes.
* The messages end with 2 termination characters.
* **The GPIB EOI line is never asserted to indicate the end of a message!**

Both the `pyvisa` `read()` and `read_raw()` commands will keep on reading until they
see `EOI`, even if you specify a size of 21 with `read_raw()`! To only way to correctly
read the data is by using `read_bytes()`. 

Like this:

```python
import pyvisa

rm=pyvisa.ResourceManager()
inst = rm.open_resource("GPIB::14")
inst.write("RGS")
inst.read_bytes(21)      <<<<<<<<<<
```

# When to Expect Data to Read 

A final, minor, issue was knowing when the 1992 returns data.

Most instruments have a request-reply protocol, where the instrument only has data ready
to be read after the controller asks for it.

Not so for the 1992: it will indeed prepare data to be read after it has been sent
a command that starts with an `R`, but it also places data in a read-data FIFO whenever
it completes a new measurement. Note also that there is no `R` command to read back
a measurement, you just have to assume that there's going to be data available when
you issue a GPIB read. If not, then `pyvisa` will time out.

When you send an `R` command, the read-data FIFO gets clear, you can be sure that
the first data after an `R` will be the data that you requested.

If you can't predict whether or not there'll be data available in the read-data FIFO,
e.g. because you're measuring events that don't happen at predictable points of time,
then you can program the 1992 to assert the GPIB SRQ (Service ReQuest) line when there's
data available, and use the `pyvisa` 
[`wait_for_srq()`](https://pyvisa.readthedocs.io/en/latest/api/resources.html#pyvisa.resources.GPIBInstrument.wait_for_srq)
function.

Unfortunately, SRQ handling is not supported only Linux machine with `pyvisa` and the
low-level `pyvisa-py` driver, so I wasn't able to test that.

The other alternative is to program is very large timeout:

```python
inst.timeout=10000
```


