
<html>
    <head>
        <title>CVT Calculator</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    </head>
    <body>
        <script>
            function check_integer(value, result_id) {
                var n = Number(value)
                if (Number.isInteger(n)){
                    $(result_id).text("Ok");
                    return true;
                }
                else{
                    $(result_id).text("Enter integer!");
                    return false;
                }
            }

            var CLOCK_STEP;
            var H_SYNC_PER              = 0.08;
            var MIN_V_PORCH_RND         = 3;
            var MIN_V_BPORCH;
            var MIN_VSYNC_BP            = 550;
            var RB_H_BLANK              = 160;
            var RB_H_SYNC               = 32;
            var RB_MIN_V_BLANK          = 460;
            var RB_V_FPORCH             = 3;
            var MARGIN_PER              = 1.8;
            var C_PRIME                 = 30;
            var M_PRIME                 = 300;

            var CELL_GRAN               = 8;
            var CELL_GRAN_RND;

            var IP_FREQ_RQD;
            var V_FIELD_RATE_RQD;
            var MARGINS_RQD;

            var H_PIXELS;
            var H_PIXELS_RND;
            var LEFT_MARGIN;
            var RIGHT_MARGIN;
            var TOTAL_ACTIVE_PIXELS;
            var V_LINES;
            var V_LINES_RND;
            var TOP_MARGIN;
            var BOT_MARGIN;

            var INTERLACE;

            var ASPECT_RATIO;
            var V_SYNC_RND;

            var H_PERIOD_EST;
            var V_SYNC_BP;
            var V_BACK_PORCH;
            var TOTAL_V_LINES;
            var IDEAL_DUTY_CYCLE;
            var H_BLANK;
            var TOTAL_PIXELS;
            var ACT_PIXEL_FREQ;
            var ACT_H_FREQ;
            var ACT_FIELD_RATE;
            var ACT_FRAME_RATE;
            var V_BLANK;

            function calculate_cvt(horiz_pixels, vert_pixels, refresh_rate, margins, interlaced, reduced_blanking, video_optimized){

                if (reduced_blanking == "n" || reduced_blanking == "rb"){
                    CLOCK_STEP          = 0.25;
                    MIN_V_BPORCH        = 6;
                    RB_H_BLANK          = 160;
                    RB_H_SYNC           = 32;
                    RB_MIN_V_BLANK      = 460;
                    RB_V_FPORCH         = 3;
                    REFRESH_MULTIPLIER  = 1;
                }
                else if (reduced_blanking == "rb_v2"){
                    CLOCK_STEP          = 0.001;
                    MIN_V_BPORCH        = 6;
                    RB_H_BLANK          = 80;
                    RB_H_SYNC           = 32;
                    RB_MIN_V_BLANK      = 460;
                    RB_V_FPORCH         = 1;
                    REFRESH_MULTIPLIER  = video_optimized ? 1000/1001 : 1;
                }

                // Input parameters
                H_PIXELS            = horiz_pixels;
                V_LINES             = vert_pixels;
                IP_FREQ_RQD         = refresh_rate;
                MARGINS_RQD         = margins;
                INT_RQD             = interlaced;

                CELL_GRAN_RND       = Math.floor(CELL_GRAN);

                // 5.2 Computation of Common Parameters
                V_FIELD_RATE_RQD    = INT_RQD ? IP_FREQ_RQD * 2 : IP_FREQ_RQD;

                H_PIXELS_RND        = Math.floor(H_PIXELS / CELL_GRAN_RND) * CELL_GRAN_RND;

                LEFT_MARGIN         = MARGINS_RQD ? (Math.floor((H_PIXELS_RND * MARGIN_PER / 100) / CELL_GRAN_RND) * CELL_GRAN_RND) : 0;
                RIGHT_MARGIN        = LEFT_MARGIN;

                TOTAL_ACTIVE_PIXELS = H_PIXELS_RND + LEFT_MARGIN + RIGHT_MARGIN;
                
                V_LINES_RND         = INT_RQD ? Math.floor(V_LINES / 2) : Math.floor(V_LINES);

                TOP_MARGIN          = MARGINS_RQD ? Math.floor(V_LINES_RND * MARGIN_PER / 100) : 0;
                BOT_MARGIN          = TOP_MARGIN;

                INTERLACE           = INT_RQD ? 0.5 : 0;

                // Calculate Aspect Ratio
                var ver_pixels = INT_RQD ? 2 * V_LINES_RND : V_LINES_RND;
                var hor_pixels_4_3   = CELL_GRAN_RND * Math.round(ver_pixels *  4 /  3) / CELL_GRAN_RND;
                var hor_pixels_16_9  = CELL_GRAN_RND * Math.round(ver_pixels * 16 /  9) / CELL_GRAN_RND;
                var hor_pixels_16_10 = CELL_GRAN_RND * Math.round(ver_pixels * 16 / 10) / CELL_GRAN_RND;
                var hor_pixels_5_4   = CELL_GRAN_RND * Math.round(ver_pixels *  5 /  4) / CELL_GRAN_RND;
                var hor_pixels_15_9  = CELL_GRAN_RND * Math.round(ver_pixels * 15 /  9) / CELL_GRAN_RND;
                var hor_pixels_43_18 = CELL_GRAN_RND * Math.round(ver_pixels * 43 / 18) / CELL_GRAN_RND;
                var hor_pixels_64_27 = CELL_GRAN_RND * Math.round(ver_pixels * 64 / 27) / CELL_GRAN_RND;
                var hor_pixels_12_5  = CELL_GRAN_RND * Math.round(ver_pixels * 12 /  5) / CELL_GRAN_RND;

                ASPECT_RATIO = (hor_pixels_4_3   == H_PIXELS_RND) ? "4:3"   : 
                               (hor_pixels_16_9  == H_PIXELS_RND) ? "16:9"  : 
                               (hor_pixels_16_10 == H_PIXELS_RND) ? "16:10" : 
                               (hor_pixels_5_4   == H_PIXELS_RND) ? "5:4"   : 
                               (hor_pixels_15_9  == H_PIXELS_RND) ? "15:9"  : 
                               // Following aspect ratios are not defined by the spec...
                               (hor_pixels_43_18 == H_PIXELS_RND) ? "43:18" : 
                               (hor_pixels_64_27 == H_PIXELS_RND) ? "64:27" : 
                               (hor_pixels_12_5  == H_PIXELS_RND) ? "12:5"  : 
                                                                    "Unknown";
                console.log("ASPECT_RATIO: " + ASPECT_RATIO);

                // V_SYNC_RND depends on aspect ratio and reduced blanking
                if      (reduced_blanking == "rb_v2") V_SYNC_RND = 8;
                else if (ASPECT_RATIO == "4:3")       V_SYNC_RND = 4;
                else if (ASPECT_RATIO == "16:9")      V_SYNC_RND = 5;
                else if (ASPECT_RATIO == "16:10")     V_SYNC_RND = 6;
                else if (ASPECT_RATIO == "5:4")       V_SYNC_RND = 7;
                else if (ASPECT_RATIO == "15:9")      V_SYNC_RND = 7;
                else                                  V_SYNC_RND = 10;

                if (reduced_blanking == "n"){
                    // 5.3 Computation of CRT Timing Parameters
                    H_PERIOD_EST = ((1 / V_FIELD_RATE_RQD) - MIN_VSYNC_BP / 1000000.0) / (V_LINES_RND + (2 * TOP_MARGIN) + MIN_V_PORCH_RND + INTERLACE) * 1000000.0;

                    V_SYNC_BP = Math.floor(MIN_VSYNC_BP / H_PERIOD_EST) + 1;
                    if (V_SYNC_BP < (V_SYNC_RND + MIN_V_BPORCH)){
                        V_SYNC_BP = V_SYNC_RND + MIN_V_BPORCH;
                    }

                    V_BACK_PORCH = V_SYNC_BP - V_SYNC_RND;

                    TOTAL_V_LINES = V_LINES_RND + TOP_MARGIN + BOT_MARGIN + V_SYNC_BP + INTERLACE + MIN_V_PORCH_RND;

                    IDEAL_DUTY_CYCLE = C_PRIME - (M_PRIME * H_PERIOD_EST/1000);

                    if (IDEAL_DUTY_CYCLE < 20){
                        H_BLANK = Math.floor(TOTAL_ACTIVE_PIXELS * 20 / (100-20) / (2 * CELL_GRAN_RND)) * (2 * CELL_GRAN_RND);
                    }
                    else{
                        H_BLANK = Math.floor(TOTAL_ACTIVE_PIXELS * IDEAL_DUTY_CYCLE / (100 - IDEAL_DUTY_CYCLE) / (2 * CELL_GRAN_RND)) * (2 * CELL_GRAN_RND);
                    }

                    TOTAL_PIXELS = TOTAL_ACTIVE_PIXELS + H_BLANK;

                    ACT_PIXEL_FREQ = CLOCK_STEP * Math.floor(TOTAL_PIXELS / H_PERIOD_EST / CLOCK_STEP);
                }
                else{
                    H_PERIOD_EST = ((1000000 / V_FIELD_RATE_RQD) - RB_MIN_V_BLANK) / (V_LINES_RND + TOP_MARGIN + BOT_MARGIN);
                    H_BLANK = RB_H_BLANK;

                    VBI_LINES = Math.floor(RB_MIN_V_BLANK / H_PERIOD_EST) + 1;

                    RB_MIN_VBI = RB_V_FPORCH + V_SYNC_RND + MIN_V_BPORCH;
                    ACT_VBI_LINES = (VBI_LINES < RB_MIN_VBI) ? RB_MIN_VBI : VBI_LINES;

                    TOTAL_V_LINES = ACT_VBI_LINES + V_LINES_RND + TOP_MARGIN + BOT_MARGIN + INTERLACE;

                    TOTAL_PIXELS = RB_H_BLANK + TOTAL_ACTIVE_PIXELS;

                    ACT_PIXEL_FREQ = CLOCK_STEP * Math.floor((V_FIELD_RATE_RQD * TOTAL_V_LINES * TOTAL_PIXELS / 1000000 * REFRESH_MULTIPLIER) / CLOCK_STEP);
                }

                ACT_H_FREQ = 1000 * ACT_PIXEL_FREQ / TOTAL_PIXELS;

                ACT_FIELD_RATE = 1000 * ACT_H_FREQ / TOTAL_V_LINES;

                ACT_FRAME_RATE = INT_RQD ? ACT_FIELD_RATE / 2 : ACT_FIELD_RATE;

                V_BLANK = V_SYNC_BP + MIN_V_PORCH_RND;

                console.log("ACT_FRAME_RATE: " + ACT_FRAME_RATE);
                console.log("ACT_FIELD_RATE: " + ACT_FIELD_RATE);
                console.log("");
                console.log("PIXEL FREQ:     " + ACT_PIXEL_FREQ);
                console.log("");
                console.log("H TOTAL:        " + TOTAL_PIXELS);
                console.log("H WIDTH:        " + TOTAL_ACTIVE_PIXELS);
                console.log("H FREQ:         " + ACT_H_FREQ);
                console.log("");
                console.log("V TOTAL:        " + TOTAL_V_LINES);
                console.log("V HEIGHT:       " + V_LINES_RND);
                console.log("V FREQ:         " + ACT_FRAME_RATE);
                console.log("---------------------------");
            }

            
        </script>
        <h1>CVT Calculator</h1>
        <h2>Input Parameters</h2>
            <form id="parameters">
                <table>
                    <tr>
                        <td><label>Horizontal Pixels</label></td>
                        <td><input id="horiz_pixels" type="text" value="640" /></td>
                        <td><label id="horiz_valid">Ok</label></td>
                    </tr>
                    <tr>
                        <td><label>Vertical Pixels</label></td>
                        <td><input id="vert_pixels" type="text" value="480" /></td>
                        <td><label id="vert_valid">Ok</label></td>
                    </tr>
                    <tr>
                        <td><label>Refersh Rate (Hz)</label></td>
                        <td><input id="refresh_rate" type="text" value="60" /></td>
                        <td><label id="refresh_valid">Ok</label></td>
                    </tr>
                    <tr>
                        <td><label>Margins</label></td>
                        <td><select id="margins" name="margins"><option value="y">Yes</option><option value="n" selected>No</option></select>
                    </tr>
                    <tr>
                        <td><label>Interlaced</label></td>
                        <td><select id="interlaced" name="interlaced"><option value="y">Yes</option><option value="n" selected>No</option></select>
                    </tr>
                </table>
            </form>

            <script type="text/javascript">
                $('#horiz_pixels').change( function(){ check_integer($('#horiz_pixels').attr("value"), '#horiz_valid');   update_status(); })
                $('#vert_pixels') .change( function(){ check_integer($('#vert_pixels').attr("value"), '#vert_valid');     update_status(); })
                $('#refresh_rate').change( function(){ check_integer($('#refresh_rate').attr("value"), '#refresh_valid'); update_status(); })
                $('#margins')         .change( function(){ update_status(); })
                $('#interlaced')      .change( function(){ update_status(); })
            </script>
        <h2>Status</h2>
            <table>
                <tr>
                    <th></th>
                    <th>CVT</th>
                    <th>CVT-RB</th>
                    <th>CVT-RBv2</th>
                    <th></th>
                </tr>
                <tr>
                    <td><label>Aspect Ratio</label></td>
                    <td><label id="cvt-aspect_ratio"></label></td>
                    <td><label id="cvt_rb-aspect_ratio"></label></td>
                    <td><label id="cvt_rb2-aspect_ratio"></label></td>
                </tr>
                <tr>
                    <td><label>Pixel Clock</label></td>
                    <td><label id="cvt-pclock"></label></td>
                    <td><label id="cvt_rb-pclock"></label></td>
                    <td><label id="cvt_rb2-pclock"></label></td>
                    <td><label>MHz</label></td>
                </tr>
                <tr>
                    <td><label>H Total</label></td>
                    <td><label id="cvt-htotal"></label></td>
                    <td><label id="cvt_rb-htotal"></label></td>
                    <td><label id="cvt_rb2-htotal"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>H Pixels</label></td>
                    <td><label id="cvt-hpixels"></label></td>
                    <td><label id="cvt_rb-hpixels"></label></td>
                    <td><label id="cvt_rb2-hpixels"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>H Blank</label></td>
                    <td><label id="cvt-hblank"></label></td>
                    <td><label id="cvt_rb-hblank"></label></td>
                    <td><label id="cvt_rb2-hblank"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>H Freq</label></td>
                    <td><label id="cvt-hfreq"></label></td>
                    <td><label id="cvt_rb-hfreq"></label></td>
                    <td><label id="cvt_rb2-hfreq"></label></td>
                    <td><label>kHz</label></td>
                </tr>

                <tr>
                    <td><label>V Total</label></td>
                    <td><label id="cvt-vtotal"></label></td>
                    <td><label id="cvt_rb-vtotal"></label></td>
                    <td><label id="cvt_rb2-vtotal"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>V Pixels</label></td>
                    <td><label id="cvt-vpixels"></label></td>
                    <td><label id="cvt_rb-vpixels"></label></td>
                    <td><label id="cvt_rb2-vpixels"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>V Blank</label></td>
                    <td><label id="cvt-vblank"></label></td>
                    <td><label id="cvt_rb-vblank"></label></td>
                    <td><label id="cvt_rb2-vblank"></label></td>
                    <td><label>Pixels</label></td>
                </tr>
                <tr>
                    <td><label>V Freq</label></td>
                    <td><label id="cvt-vfreq"></label></td>
                    <td><label id="cvt_rb-vfreq"></label></td>
                    <td><label id="cvt_rb2-vfreq"></label></td>
                    <td><label>Hz</label></td>
                </tr>
            </table>


            <script type="text/javascript">

                function check_values(){
                }

                function update_status(){
                    var horiz_pixels        = Number($('#horiz_pixels').attr("value"));
                    var vert_pixels         = Number($('#vert_pixels').attr("value"));
                    var refresh_rate        = Number($('#refresh_rate').attr("value"));
                    var margins             = $('#margins').attr("value") == "y";
                    var interlaced          = $('#interlaced').attr("value") == "y";

                    calculate_cvt(horiz_pixels, vert_pixels, refresh_rate, margins, interlaced, "n", false);

                    $("#cvt-aspect_ratio").text(ASPECT_RATIO);

                    $("#cvt-pclock").text(Math.round(ACT_PIXEL_FREQ*1000)/1000);

                    $("#cvt-htotal").text(TOTAL_PIXELS);
                    $("#cvt-hpixels").text(TOTAL_ACTIVE_PIXELS);
                    $("#cvt-hblank").text(H_BLANK);
                    $("#cvt-hfreq").text(Math.round(ACT_H_FREQ*1000)/1000);

                    $("#cvt-vtotal").text(TOTAL_V_LINES);
                    $("#cvt-vpixels").text(V_LINES_RND);
                    $("#cvt-vblank").text(V_BLANK);
                    $("#cvt-vfreq").text(Math.round(ACT_FRAME_RATE*1000)/1000);

                    calculate_cvt(horiz_pixels, vert_pixels, refresh_rate, margins, interlaced, "rb", false);

                    $("#cvt_rb-aspect_ratio").text(ASPECT_RATIO);

                    $("#cvt_rb-pclock").text(Math.round(ACT_PIXEL_FREQ*1000)/1000);

                    $("#cvt_rb-htotal").text(TOTAL_PIXELS);
                    $("#cvt_rb-hpixels").text(TOTAL_ACTIVE_PIXELS);
                    $("#cvt_rb-hblank").text(H_BLANK);
                    $("#cvt_rb-hfreq").text(Math.round(ACT_H_FREQ*1000)/1000);

                    $("#cvt_rb-vtotal").text(TOTAL_V_LINES);
                    $("#cvt_rb-vpixels").text(V_LINES_RND);
                    $("#cvt_rb-vblank").text(V_BLANK);
                    $("#cvt_rb-vfreq").text(Math.round(ACT_FRAME_RATE*1000)/1000);

                    calculate_cvt(horiz_pixels, vert_pixels, refresh_rate, margins, interlaced, "rb_v2", false);

                    $("#cvt_rb2-aspect_ratio").text(ASPECT_RATIO);

                    $("#cvt_rb2-pclock").text(Math.round(ACT_PIXEL_FREQ*1000)/1000);

                    $("#cvt_rb2-htotal").text(TOTAL_PIXELS);
                    $("#cvt_rb2-hpixels").text(TOTAL_ACTIVE_PIXELS);
                    $("#cvt_rb2-hblank").text(H_BLANK);
                    $("#cvt_rb2-hfreq").text(Math.round(ACT_H_FREQ*1000)/1000);

                    $("#cvt_rb2-vtotal").text(TOTAL_V_LINES);
                    $("#cvt_rb2-vpixels").text(V_LINES_RND);
                    $("#cvt_rb2-vblank").text(V_BLANK);
                    $("#cvt_rb2-vfreq").text(Math.round(ACT_FRAME_RATE*1000)/1000);
                }

                window.onload = update_status();
                
            </script>
    </body>
</html>

